<!--
    Simple platform game created by me to learn how to use Canvas on Javascript
    Created by: Erik Ricku  
    Date: 2025/05/13
    GitHub: https://github.com/WikiErik
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Platform</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
        canvas { border: 1px solid black; background-color: #ffffff; }
        #GameOverText { margin-top: 15px; font-size: 24px; font-weight: bold; color: #333; text-align: center;}
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="GameOverText"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameovertext = document.getElementById('GameOverText');

        // --- Game State ---
        let gameState = "initial"; // "initial", "playing", "gameOver"

        // --- Timer Variables ---
        let startTime = 0;
        let finalTime = 0;

        // --- Player Object (defined globally so it exists for initial draw) ---
        const player = {
            x: 50, y: 50, width: 40, height: 40, color: 'blue',
            speed: 4, dx: 0, velocityY: 0, gravity: 0.6,
            jumpStrength: 13,
            isGrounded: false
        };

        // --- Platforms (defined globally) ---
        const platforms = [
            { x: 100, y: canvas.height - 70, width: 200, height: 20, color: 'green', goal: false },
            { x: 350, y: canvas.height - 150, width: 150, height: 20, color: 'orange', goal: false},
            { x: 50,  y: canvas.height - 250, width: 100, height: 20, color: 'purple', goal: false },
            { x: 550, y: canvas.height - 220, width: 200, height: 20, color: 'brown', goal: true}
        ];

        // --- Keyboard Input State ---
        const keysPressed = {}; // Keep this global for simplicity

        if (ctx && gameovertext) {
            console.log("Canvas and context are ready!");

            // --- Event Listeners ---
            window.addEventListener('keydown', function(event) {
                if (gameState === "initial") {
                    runGame(); // Start the game on first key press
                } else if (gameState === "playing") {
                    keysPressed[event.key] = true;
                    if ((event.key === 'ArrowUp' || event.key === 'w' || event.key === ' ') && player.isGrounded) {
                        player.velocityY = -player.jumpStrength;
                        player.isGrounded = false;
                    }
                } else if (gameState === "gameOver") {
                    initializeGame(); // Reset visuals and state
                    runGame();        // Start a new game
                }
            });

            window.addEventListener('keyup', function(event) {
                if (gameState === "playing") {
                    delete keysPressed[event.key];
                }
            });

            // --- Collision Detection ---
            function checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }

            // --- Game Over Function ---
            function triggerGameOver(cause) {
                if (gameState !== "playing") return; // Prevent multiple calls

                gameState = "gameOver";
                finalTime = (performance.now() - startTime) / 1000;

                if (cause) { // true = win
                    gameovertext.textContent = `Hai vinto! Tempo: ${finalTime.toFixed(2)}s. Premi un tasto per rigiocare.`;
                } else { // false = lose
                    gameovertext.textContent = `Hai perso! Tempo: ${finalTime.toFixed(2)}s. Premi un tasto per rigiocare.`;
                }
                console.log(`Game Over. Final Time: ${finalTime.toFixed(3)}s`);
                draw(); // Draw the final game over screen once
            }

            // --- Update Function ---
            function update() {
                if (gameState !== "playing") return;

                // Horizontal movement
                player.dx = 0;
                if (keysPressed['ArrowLeft'] || keysPressed['a']) player.dx = -player.speed;
                if (keysPressed['ArrowRight'] || keysPressed['d']) player.dx = player.speed;
                player.x += player.dx;
                if (player.x < 0) player.x = 0;
                if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

                // Vertical movement & Collision
                player.velocityY += player.gravity;
                let oldPlayerY = player.y;
                player.y += player.velocityY;
                player.isGrounded = false;

                let landedOnGoal = false;
                for (let i = 0; i < platforms.length; i++) {
                    const platform = platforms[i];
                    if (checkCollision(player, platform)) {
                        if (player.velocityY > 0 && (oldPlayerY + player.height) <= platform.y) {
                            player.y = platform.y - player.height;
                            player.velocityY = 0;
                            player.isGrounded = true;
                            if (platform.goal === true) landedOnGoal = true;
                        }
                    }
                }

                if (landedOnGoal) {
                    triggerGameOver(true); return;
                }

                let landedOnFloor = false;
                if (!player.isGrounded && (player.y + player.height) >= canvas.height) {
                    player.y = canvas.height - player.height;
                    player.velocityY = 0;
                    player.isGrounded = true;
                    landedOnFloor = true;
                }
                if (landedOnFloor) {
                    triggerGameOver(false); return;
                }

                if (player.y < 0 && player.velocityY < 0) {
                    player.y = 0; player.velocityY = 0;
                }
            }

            // --- Draw Function ---
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                for (let i = 0; i < platforms.length; i++) {
                    const p = platforms[i];
                    ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.width, p.height);
                }
                ctx.fillStyle = player.color; ctx.fillRect(player.x, player.y, player.width, player.height);

                let displayTimeSeconds = 0;
                if (gameState === "playing") {
                    displayTimeSeconds = (performance.now() - startTime) / 1000;
                } else if (gameState === "gameOver") {
                    displayTimeSeconds = finalTime;
                }
                // For "initial" state, displayTimeSeconds remains 0

                ctx.font = "20px Arial"; ctx.fillStyle = "black";
                ctx.textAlign = "left"; ctx.textBaseline = "top";
                ctx.fillText(`Tempo: ${displayTimeSeconds.toFixed(2)}s`, 10, 10);

                if (gameState === "initial") {
                    ctx.font = "30px Arial"; ctx.fillStyle = "rgba(0,0,0,0.8)";
                    ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText("Premi un tasto per iniziare!", canvas.width / 2, canvas.height / 2);
                }
            }

            // --- Animation Loop ---
            function gameLoop() {
                if (gameState !== "playing") return; // Only loop if playing

                update();
                draw();
                requestAnimationFrame(gameLoop);
            }

            // --- Game Setup and Control Functions ---
            function initializeGame() {
                // Reset player state
                player.x = 50; player.y = 50; // Initial position for drawing
                player.velocityY = 0; player.dx = 0;
                player.isGrounded = false;

                // Reset game state variables
                finalTime = 0;
                for (const key in keysPressed) delete keysPressed[key]; // Clear pressed keys

                gameovertext.textContent = ""; // Clear game over message
                // gameState will be set by the calling context (e.g., to "initial" or directly to "playing")
            }

            function runGame() {
                if (gameState === "playing") return; // Prevent starting if already playing

                initializeGame(); // Ensure a clean state
                gameState = "playing";
                startTime = performance.now();
                console.log("Game Started!");
                gameLoop(); // Start the animation loop
            }

            // --- Initial Page Load ---
            initializeGame(); // Setup initial player pos etc.
            gameState = "initial"; // Set state for initial screen
            draw(); // Draw the initial "Press any key to start" screen

        } else {
            if (!ctx) console.error("Failed to get 2D context.");
            if (!gameovertext) console.error("Failed to find GameOverText element.");
            alert("Sorry, there was an error initializing the game.");
        }
    </script>
</body>
</html>